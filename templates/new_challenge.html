{% extends 'base.html' %}

{% block title %}Novo Desafio - Liga Olímpica de Golfe{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Novo Desafio</h3>
        </div>
        <div class="card-body">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% if is_admin %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Modo Administrador:</strong> 
                Você pode criar desafios para qualquer jogador. Selecione primeiro o desafiante e depois o jogador a ser desafiado.
                As regras de tier e posição ainda se aplicam.
            </div>
            {% endif %}
            
            {% if not preselected_challenger %}
                <!-- Etapa 1: Selecionar o desafiante -->
                <h4>Selecione o Jogador Desafiante:</h4>
                <div class="row">
                    {% for player in all_players %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">{{ player.name }}</h5>
                                <p class="card-text">
                                    <strong>Posição:</strong> {{ player.position }}<br>
                                    <strong>Tier:</strong> {{ player.tier }}
                                </p>
                                <a href="{{ url_for('new_challenge', challenger_id=player.id) }}" class="btn btn-primary">
                                    Selecionar como Desafiante
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Etapa 2: Mostrar desafiante selecionado e escolher desafiado -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h5 class="mb-0">Desafiante Selecionado</h5>
                            </div>
                            <div class="card-body">
                                <h4>{{ challenger_info.name }}</h4>
                                <p>
                                    <strong>Posição:</strong> {{ challenger_info.position }}<br>
                                    <strong>Tier:</strong> {{ challenger_info.tier }}
                                </p>
                                <a href="{{ url_for('new_challenge') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Escolher outro desafiante
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if eligible_challenged|length > 0 %}
                    <h4>Selecione o Jogador a ser Desafiado:</h4>
                    
                    <form method="POST" action="{{ url_for('new_challenge') }}" class="mt-4" id="challenge-form">
                        <input type="hidden" name="challenger_id" value="{{ preselected_challenger }}">
                        
                        <div class="mb-3">
                            <label for="challenged_id" class="form-label">Jogador a ser desafiado:</label>
                            <select class="form-select" id="challenged_id" name="challenged_id" required>
                                <option value="">-- Selecione o jogador --</option>
                                {% for player in eligible_challenged %}
                                <option value="{{ player.id }}">
                                    {{ player.name }} (Posição: {{ player.position }}, Tier: {{ player.tier }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="scheduled_date" class="form-label">Data do Desafio <small class="text-muted">(Máximo 7 dias a partir de hoje)</small>:</label>
                            <input type="date" class="form-control" id="scheduled_date" name="scheduled_date" 
                                   min="{{ today_date }}" value="{{ today_date }}" required>
                            <div id="date-error" class="text-danger mt-1"></div>
                            <small class="form-text text-muted">A data do desafio deve estar entre hoje e os próximos 7 dias.</small>
                        </div>
                        
                        <div class="mb-3">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle"></i> Criar Desafio
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Não há jogadores elegíveis para serem desafiados por este jogador.
                        <p class="mb-0 mt-2">Lembre-se: um jogador só pode desafiar outros que:</p>
                        <ul class="mb-0">
                            <li>Estão ativos</li>
                            <li>Estão no mesmo nível ou um nível acima</li>
                            <li>Têm posição melhor (numero menor)</li>
                            <li>Não estão envolvidos em outros desafios pendentes</li>
                        </ul>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

{% if preselected_challenger and eligible_challenged|length > 0 %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para calcular a data máxima (hoje + 7 dias)
    function getMaxDate() {
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 7);
        return maxDate;
    }
    
    // Formatar data para o formato yyyy-mm-dd (usado em inputs date)
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Função para validar a data selecionada
    function validateDate() {
        const scheduledDateField = document.getElementById('scheduled_date');
        const selectedDate = new Date(scheduledDateField.value);
        
        // Ajustar para comparar apenas datas (sem horário)
        selectedDate.setHours(0, 0, 0, 0);
        
        // Data de hoje
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Data máxima (hoje + 7 dias)
        const maxDate = getMaxDate();
        maxDate.setHours(23, 59, 59, 0);
        
        const errorElement = document.getElementById('date-error');
        
        if (selectedDate < today) {
            errorElement.textContent = "A data do desafio não pode ser anterior à data atual.";
            scheduledDateField.setCustomValidity("Data inválida");
            return false;
        } else if (selectedDate > maxDate) {
            errorElement.textContent = "A data do desafio não pode ser superior a 7 dias da data atual.";
            scheduledDateField.setCustomValidity("Data inválida");
            return false;
        } else {
            errorElement.textContent = "";
            scheduledDateField.setCustomValidity("");
            return true;
        }
    }
    
    // Aplicar a validação ao campo de data
    const scheduledDateField = document.getElementById('scheduled_date');
    if (scheduledDateField) {
        // Definir a data máxima (7 dias a partir de hoje)
        const maxDate = getMaxDate();
        scheduledDateField.max = formatDateForInput(maxDate);
        
        // Adicionar eventos de validação
        scheduledDateField.addEventListener('change', validateDate);
        scheduledDateField.addEventListener('input', validateDate);
        
        // Validar data inicial
        validateDate();
        
        // Adicionar validação ao envio do formulário
        const form = document.getElementById('challenge-form');
        if (form) {
            form.addEventListener('submit', function(event) {
                if (!validateDate()) {
                    event.preventDefault();
                }
            });
        }
    }
});
</script>
{% endif %}
{% endblock %}
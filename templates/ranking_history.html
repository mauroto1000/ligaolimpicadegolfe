{% extends 'base.html' %}

{% block title %}Histórico Geral de Posições - Liga Olímpica de Golfe{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .history-card {
        margin-top: 20px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        position: relative;
        height: 600px;
        width: 100%;
        margin-top: 20px;
    }
    
    .time-filter {
        margin-bottom: 20px;
    }
    
    .player-selector {
        margin-bottom: 20px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .controls-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-check-label {
        cursor: pointer;
    }
    
    @media (max-width: 767px) {
        .chart-container {
            height: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card history-card">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Histórico Geral de Posições</h3>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <p>Este gráfico mostra a evolução das posições de vários jogadores ao longo do tempo.</p>
            <p>Selecione os jogadores que deseja visualizar e o período de tempo.</p>
        </div>
        
        <div class="controls-container">
            <!-- Filtros de tempo -->
            <div class="time-filter">
                <h5>Período</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary time-btn {% if days == 7 %}active{% endif %}" data-days="7">7 dias</button>
                    <button type="button" class="btn btn-outline-secondary time-btn {% if days == 30 or not days %}active{% endif %}" data-days="30">30 dias</button>
                    <button type="button" class="btn btn-outline-secondary time-btn {% if days == 90 %}active{% endif %}" data-days="90">90 dias</button>
                    <button type="button" class="btn btn-outline-secondary time-btn {% if days == 180 %}active{% endif %}" data-days="180">6 meses</button>
                    <button type="button" class="btn btn-outline-secondary time-btn {% if days == 365 %}active{% endif %}" data-days="365">1 ano</button>
                </div>
            </div>
            
            <!-- Seleção de visualização -->
            <div>
                <h5>Visualização</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary view-btn active" data-view="normal">Normal</button>
                    <button type="button" class="btn btn-outline-primary view-btn" data-view="relative">Relativa</button>
                </div>
                <small class="d-block text-muted mt-1">Relativa: mostra a variação ao invés da posição absoluta</small>
            </div>
        </div>
        
        <!-- Seletor de jogadores -->
        <div class="row">
            <div class="col-12">
                <h5>Selecione os jogadores:</h5>
                <div class="player-selector">
                    <div class="d-grid gap-2 mb-2">
                        <button type="button" id="selectAll" class="btn btn-sm btn-outline-secondary">Selecionar Todos</button>
                        <button type="button" id="selectNone" class="btn btn-sm btn-outline-secondary">Desmarcar Todos</button>
                        <button type="button" id="selectTop10" class="btn btn-sm btn-outline-primary">Top 10</button>
                    </div>
                    
                    <div class="row">
                        {% for player in players %}
                            <div class="col-md-3 col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input player-checkbox" type="checkbox" 
                                           id="player_{{ player.id }}" value="{{ player.id }}" 
                                           {% if loop.index <= 10 %}checked{% endif %}>
                                    <label class="form-check-label" for="player_{{ player.id }}">
                                        {{ player.name }}
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <button type="button" id="updateChart" class="btn btn-primary mt-3">
                    <i class="fas fa-sync-alt"></i> Atualizar Gráfico
                </button>
            </div>
        </div>
        
        <!-- Container do gráfico -->
        <div class="chart-container mt-4">
            <canvas id="rankingChart"></canvas>
        </div>
        
        <!-- Botões de navegação -->
        <div class="mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar para Ranking
            </a>
            <a href="{{ url_for('pyramid_dynamic') }}" class="btn btn-primary">
                <i class="fas fa-sitemap me-2"></i>Ver Pirâmide
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos do DOM
    const timeButtons = document.querySelectorAll('.time-btn');
    const viewButtons = document.querySelectorAll('.view-btn');
    const playerCheckboxes = document.querySelectorAll('.player-checkbox');
    const updateChartButton = document.getElementById('updateChart');
    const selectAllButton = document.getElementById('selectAll');
    const selectNoneButton = document.getElementById('selectNone');
    const selectTop10Button = document.getElementById('selectTop10');
    
    // Variáveis de configuração
    let currentDays = {{ days }};
    let currentView = 'normal'; // 'normal' ou 'relative'
    let rankingChart = null;
    
    // Gerar cores únicas para cada jogador
    function generateColors(count) {
        const baseColors = [
            '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f',
            '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab',
            '#d37295', '#a6cee3', '#1f78b4', '#b2df8a', '#33a02c',
            '#fb9a99', '#e31a1c', '#fdbf6f', '#ff7f00', '#cab2d6',
            '#6a3d9a', '#ffff99', '#b15928', '#8dd3c7', '#bebada',
            '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5'
        ];
        
        // Repetir as cores se houver mais jogadores que cores
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(baseColors[i % baseColors.length]);
        }
        
        return colors;
    }
    
    // Criar o gráfico inicialmente
    function createChart() {
        const ctx = document.getElementById('rankingChart').getContext('2d');
        
        // Adicionar padding extra à esquerda para os nomes dos jogadores
        Chart.defaults.layout.padding.left = 140;
        
        rankingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return 'Data: ' + tooltipItems[0].label;
                            },
                            label: function(context) {
                                const playerName = context.dataset.label;
                                const position = context.raw;
                                if (position === null) return null;
                                
                                if (currentView === 'normal') {
                                    return `${playerName}: ${position}º lugar`;
                                } else {
                                    // Para visualização relativa, mostrar se melhorou ou piorou
                                    const sign = position < 0 ? '+' : (position > 0 ? '-' : '');
                                    const change = Math.abs(position);
                                    return `${playerName}: ${sign}${change} posições`;
                                }
                            }
                        }
                    },
                    legend: {
                        display: false // Sem legenda, já que temos os nomes nas linhas
                    }
                },
                scales: {
                    y: {
                        reverse: true, // Posições menores (melhores) ficam mais altas
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Posição'
                        },
                        ticks: {
                            precision: 0 // Mostrar apenas números inteiros
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Data'
                        }
                    }
                }
            }
        });
    }
    
    // Atualizar o gráfico com novos dados
    function updateChart() {
        // Obter jogadores selecionados
        const selectedPlayers = Array.from(playerCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value));
        
        if (selectedPlayers.length === 0) {
            alert('Por favor, selecione pelo menos um jogador.');
            return;
        }
        
        // Buscar os dados
        fetch(`/api/ranking_history_data?days=${currentDays}&player_ids[]=${selectedPlayers.join('&player_ids[]=')}`)
            .then(response => response.json())
            .then(data => {
                // Formatar as datas para exibição
                const formattedDates = data.dates.map(date => {
                    const parts = date.split('-');
                    return `${parts[2]}/${parts[1]}`;
                });
                
                // Preparar datasets para o gráfico
                const colors = generateColors(data.players.length);
                const datasets = [];
                
                data.players.forEach((player, index) => {
                    let positions = [];
                    
                    if (currentView === 'normal') {
                        // Usar posições absolutas
                        positions = player.positions;
                    } else {
                        // Calcular variação relativa à primeira posição
                        const firstValidPosition = player.positions.find(p => p !== null);
                        if (firstValidPosition !== undefined) {
                            positions = player.positions.map(p => {
                                if (p === null) return null;
                                return p - firstValidPosition; // Variação em relação à primeira posição
                            });
                        }
                    }
                    
                    datasets.push({
                        label: player.name,
                        data: positions,
                        borderColor: colors[index],
                        backgroundColor: colors[index] + '33', // Adiciona transparência
                        borderWidth: 2.5,
                        pointBackgroundColor: colors[index],
                        pointBorderColor: '#fff',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0.1,
                        spanGaps: true, // Conectar pontos mesmo com dados ausentes
                        lineTension: 0.3 // Suaviza a linha
                    });
                });
                
                // Adicionar nomes dos jogadores no início do gráfico
                const originalDraw = rankingChart.draw;
                rankingChart.draw = function() {
                    originalDraw.apply(this, arguments);
                    
                    const chart = this;
                    const ctx = chart.ctx;
                    const datasets = chart.data.datasets;
                    
                    datasets.forEach((dataset, i) => {
                        if (!dataset.hidden && dataset.data.length > 0) {
                            // Encontrar o primeiro ponto válido
                            let firstValidIndex = 0;
                            while (firstValidIndex < dataset.data.length && dataset.data[firstValidIndex] === null) {
                                firstValidIndex++;
                            }
                            
                            if (firstValidIndex < dataset.data.length) {
                                const meta = chart.getDatasetMeta(i);
                                const point = meta.data[firstValidIndex];
                                
                                if (point && point.y) {
                                    ctx.save();
                                    ctx.fillStyle = dataset.borderColor;
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'right';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(dataset.label, point.x - 15, point.y);
                                    ctx.restore();
                                }
                            }
                        }
                    });
                };
                
                // Atualizar o gráfico
                rankingChart.data.labels = formattedDates;
                rankingChart.data.datasets = datasets;
                
                // Ajustar a escala Y para visualização relativa
                if (currentView === 'relative') {
                    rankingChart.options.scales.y.reverse = false; // Valores negativos = melhoria
                    rankingChart.options.scales.y.title.text = 'Variação de Posição';
                } else {
                    rankingChart.options.scales.y.reverse = true; // Posições menores são melhores
                    rankingChart.options.scales.y.title.text = 'Posição';
                }
                
                rankingChart.update();
            });
    }
    
    // Botões para filtrar por período
    timeButtons.forEach(button => {
        button.addEventListener('click', function() {
            timeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            currentDays = parseInt(this.getAttribute('data-days'));
            updateChart();
        });
    });
    
    // Botões para alternar entre visualização normal e relativa
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            viewButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            currentView = this.getAttribute('data-view');
            updateChart();
        });
    });
    
    // Botões para seleção de jogadores
    selectAllButton.addEventListener('click', function() {
        playerCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    
    selectNoneButton.addEventListener('click', function() {
        playerCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    });
    
    selectTop10Button.addEventListener('click', function() {
        playerCheckboxes.forEach((checkbox, index) => {
            checkbox.checked = index < 10;
        });
    });
    
    // Botão para atualizar o gráfico
    updateChartButton.addEventListener('click', updateChart);
    
    // Inicializar o gráfico
    createChart();
    
    // Carregar dados iniciais
    updateChart();
});
</script>
{% endblock %}
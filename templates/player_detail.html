{% extends 'base.html' %}

{% block title %}{{ player.name }} - Liga Ol√≠mpica de Golfe{% endblock %}

{% block head %}
<style>
    .profile-header {
        position: relative;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .profile-header.jogador {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .profile-header.vip {
        background: linear-gradient(135deg, #ffd700, #ffb347);
        color: #333;
    }
    
    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        margin: 0 auto 15px;
        border: 4px solid rgba(255,255,255,0.5);
    }
    
    .profile-name {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .profile-code {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .profile-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin-top: 10px;
    }
    
    .profile-badge.jogador {
        background: rgba(255,255,255,0.3);
        color: white;
    }
    
    .profile-badge.vip {
        background: rgba(0,0,0,0.2);
        color: #333;
    }
    
    .info-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .info-card .card-header {
        border-radius: 10px 10px 0 0;
        font-weight: 600;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: #666;
        font-weight: 500;
    }
    
    .info-value {
        font-weight: 600;
        color: #333;
    }
    
    .action-btn {
        margin: 5px;
    }
    
    .blocked-alert {
        background: linear-gradient(135deg, #ffc107, #ffdb4d);
        border: none;
        color: #333;
    }
    
    .challenge-history-item {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-left: 4px solid #28a745;
    }
    
    .challenge-history-item.lost {
        border-left-color: #dc3545;
    }
    
    .challenge-history-item.pending {
        border-left-color: #ffc107;
    }
    
    .whatsapp-section {
        background: linear-gradient(135deg, #25d366, #128c7e);
    }
    
    .whatsapp-section .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    
    <!-- Bot√£o Voltar -->
    <div class="mb-3">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Voltar ao Ranking
        </a>
        {% if is_own_profile %}
        <a href="{{ url_for('carteirinha') }}" class="btn btn-success ms-2">
            <i class="fas fa-id-card me-1"></i> Minha Carteirinha
        </a>
        {% endif %}
    </div>
    
    <!-- Header do Perfil -->
    <div class="profile-header {% if player.tipo_membro == 'vip' %}vip{% else %}jogador{% endif %}">
        <div class="text-center">
            <div class="profile-avatar">
                {% if player.tipo_membro == 'vip' %}
                <i class="fas fa-star"></i>
                {% elif player.sexo == 'feminino' %}
                <i class="fas fa-venus"></i>
                {% else %}
                <i class="fas fa-golf-ball"></i>
                {% endif %}
            </div>
            
            <div class="profile-name">{{ player.name }}</div>
            
            <div class="profile-code">
                <i class="fas fa-hashtag"></i> {{ player.player_code or 'N/A' }}
            </div>
            
            {% if player.country %}
            <div class="mt-2">
                <img src="https://flagcdn.com/24x18/{{ player.country|country_code }}.png" 
                     alt="{{ player.country }}" class="me-1">
                {{ player.country }}
            </div>
            {% endif %}
            
            <div class="profile-badge {% if player.tipo_membro == 'vip' %}vip{% else %}jogador{% endif %}">
                {% if player.tipo_membro == 'vip' %}
                <i class="fas fa-star me-1"></i> MEMBRO VIP
                {% elif player.sexo == 'feminino' %}
                <i class="fas fa-crown me-1"></i> LIGA LADIES
                {% else %}
                <i class="fas fa-trophy me-1"></i> JOGADOR
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Alerta de Bloqueio -->
    {% if player.bloqueado == 1 %}
    <div class="alert blocked-alert">
        <h5 class="mb-2">
            {% if player.bloqueio_motivo == 'Viagem' %}üß≥
            {% elif player.bloqueio_motivo == 'Sa√∫de' %}üè•
            {% else %}üö´{% endif %}
            JOGADOR BLOQUEADO
        </h5>
        <p class="mb-1"><strong>Motivo:</strong> {{ player.bloqueio_motivo or 'N√£o informado' }}</p>
        {% if player.bloqueio_ate %}
        <p class="mb-0"><strong>At√©:</strong> {{ player.bloqueio_ate }}</p>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Coluna Esquerda -->
        <div class="col-lg-6">
            
            <!-- Informa√ß√µes do Ranking (apenas jogadores) -->
            {% if player.tipo_membro != 'vip' %}
            <div class="card info-card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-chart-line me-2"></i>Posi√ß√£o no Ranking
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h2 class="text-primary mb-0">{{ player.position or '-' }}¬∫</h2>
                            <small class="text-muted">Posi√ß√£o</small>
                        </div>
                        <div class="col-4">
                            <h2 class="text-success mb-0">{{ player.tier or '-' }}</h2>
                            <small class="text-muted">Linha</small>
                        </div>
                        <div class="col-4">
                            <h2 class="text-info mb-0">{{ player.hcp_index if player.hcp_index is not none else '-' }}</h2>
                            <small class="text-muted">HCP Index</small>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Card VIP -->
            <div class="card info-card">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-star me-2"></i>Membro VIP
                </div>
                <div class="card-body text-center">
                    <p class="mb-2">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        Carteirinha digital sempre ativa
                    </p>
                    <p class="mb-2">
                        <i class="fas fa-check-circle text-success me-1"></i>
                        Acesso ao Liga Affinity Club
                    </p>
                    <p class="mb-0 text-muted">
                        <small>Membros VIP n√£o participam do ranking de desafios.</small>
                    </p>
                </div>
            </div>
            {% endif %}
            
            <!-- Informa√ß√µes Pessoais -->
            <div class="card info-card">
                <div class="card-header bg-secondary text-white">
                    <i class="fas fa-user me-2"></i>Informa√ß√µes
                </div>
                <div class="card-body">
                    <div class="info-item">
                        <span class="info-label">Sexo</span>
                        <span class="info-value">
                            {% if player.sexo == 'feminino' %}
                            <i class="fas fa-venus text-pink"></i> Feminino
                            {% else %}
                            <i class="fas fa-mars text-primary"></i> Masculino
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Pa√≠s</span>
                        <span class="info-value">
                            {% if player.country %}
                            <img src="https://flagcdn.com/16x12/{{ player.country|country_code }}.png" 
                                 alt="{{ player.country }}" class="me-1">
                            {{ player.country }}
                            {% else %}
                            -
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value">
                            {% if player.active %}
                            <span class="badge bg-success">Ativo</span>
                            {% else %}
                            <span class="badge bg-danger">Inativo</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if player.email and (is_own_profile or session.is_admin) %}
                    <div class="info-item">
                        <span class="info-label">E-mail</span>
                        <span class="info-value">{{ player.email }}</span>
                    </div>
                    {% endif %}
                    
                    {% if player.notes %}
                    <div class="info-item">
                        <span class="info-label">Observa√ß√µes</span>
                        <span class="info-value">{{ player.notes }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- WhatsApp para Notifica√ß√µes -->
            {% if is_own_profile or session.is_admin %}
            <div class="card info-card text-white whatsapp-section">
                <div class="card-header text-white">
                    <i class="fab fa-whatsapp me-2"></i>WhatsApp para Notifica√ß√µes
                </div>
                <div class="card-body">
                    <p class="small mb-3" style="opacity: 0.9;">
                        Cadastre seu WhatsApp para receber notifica√ß√µes de desafios e interagir com o bot da Liga.
                    </p>
                    
                    <form action="{{ url_for('update_player_whatsapp', player_id=player.id) }}" method="POST">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fab fa-whatsapp text-success"></i></span>
                            <input type="text" 
                                   name="new_whatsapp" 
                                   class="form-control" 
                                   placeholder="Ex: 21999998888"
                                   value="{{ player.telefone or '' }}"
                                   pattern="[0-9]*"
                                   inputmode="numeric"
                                   maxlength="11">
                            <button type="submit" class="btn btn-light text-success">
                                <i class="fas fa-save me-1"></i>Salvar
                            </button>
                        </div>
                        <small style="opacity: 0.8;">Digite apenas n√∫meros: DDD + n√∫mero</small>
                    </form>
                    
                    <div class="mt-3">
                        {% if player.telefone %}
                        <span class="badge bg-light text-success">
                            <i class="fas fa-check me-1"></i>Cadastrado: {{ player.telefone }}
                        </span>
                        {% else %}
                        <span class="badge bg-light text-secondary">
                            <i class="fas fa-times me-1"></i>N√£o cadastrado
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
        </div>
        
        <!-- Coluna Direita -->
        <div class="col-lg-6">
            
            <!-- Desafios Ativos (apenas jogadores) -->
            {% if player.tipo_membro != 'vip' %}
            <div class="card info-card">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-crosshairs me-2"></i>Desafios Ativos
                </div>
                <div class="card-body">
                    {% if active_challenges %}
                        {% for challenge in active_challenges %}
                        <div class="challenge-history-item pending">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% if challenge.challenger_id == player.id %}
                                    <strong>{{ player.name }}</strong> ‚Üí {{ challenge.challenged_name }}
                                    <span class="badge bg-info">Desafiante</span>
                                    {% else %}
                                    {{ challenge.challenger_name }} ‚Üí <strong>{{ player.name }}</strong>
                                    <span class="badge bg-secondary">Desafiado</span>
                                    {% endif %}
                                </div>
                                <span class="badge bg-{% if challenge.status == 'pending' %}warning{% else %}success{% endif %}">
                                    {{ challenge.status|capitalize }}
                                </span>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ challenge.scheduled_date }}
                            </small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mb-0">
                            <i class="fas fa-check-circle me-1"></i>Nenhum desafio ativo
                        </p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Hist√≥rico de Desafios -->
            <div class="card info-card">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-history me-2"></i>√öltimos Desafios
                </div>
                <div class="card-body">
                    {% if recent_challenges %}
                        {% for challenge in recent_challenges[:5] %}
                        <div class="challenge-history-item {% if challenge.winner_id == player.id %}won{% else %}lost{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {{ challenge.challenger_name }} vs {{ challenge.challenged_name }}
                                </div>
                                {% if challenge.winner_id == player.id %}
                                <span class="badge bg-success">Vit√≥ria</span>
                                {% elif challenge.winner_id %}
                                <span class="badge bg-danger">Derrota</span>
                                {% else %}
                                <span class="badge bg-secondary">-</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ challenge.scheduled_date }}
                            </small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mb-0">
                            Nenhum desafio conclu√≠do ainda
                        </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- A√ß√µes Admin -->
            {% if session.is_admin %}
            <div class="card info-card">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-cog me-2"></i>Administra√ß√£o
                </div>
                <div class="card-body">
                    
                    <!-- Tipo de Membro -->
                    <div class="mb-3 pb-3 border-bottom">
                        <h6><i class="fas fa-exchange-alt me-1"></i> Tipo de Membro</h6>
                        <p class="small text-muted mb-2">
                            Status atual: 
                            {% if player.tipo_membro == 'vip' %}
                            <span class="badge bg-warning text-dark"><i class="fas fa-star"></i> Membro VIP</span>
                            {% else %}
                            <span class="badge bg-success"><i class="fas fa-golf-ball"></i> Jogador</span>
                            {% endif %}
                        </p>
                        <form action="{{ url_for('toggle_tipo_membro', player_id=player.id) }}" method="POST" class="d-inline">
                            {% if player.tipo_membro == 'vip' %}
                            <button type="submit" class="btn btn-success btn-sm" 
                                    onclick="return confirm('Converter para JOGADOR? Ser√° colocado na √∫ltima posi√ß√£o do ranking.')">
                                <i class="fas fa-golf-ball me-1"></i>Converter para Jogador
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-warning btn-sm"
                                    onclick="return confirm('Converter para VIP? Ser√° removido do ranking.')">
                                <i class="fas fa-star me-1"></i>Converter para VIP
                            </button>
                            {% endif %}
                        </form>
                    </div>
                    
                    <!-- Carteirinha For√ßada -->
                    {% if player.tipo_membro != 'vip' %}
                    <div class="mb-3 pb-3 border-bottom">
                        <h6><i class="fas fa-id-card me-1"></i> Carteirinha</h6>
                        <form action="{{ url_for('toggle_carteirinha_forcada', player_id=player.id) }}" method="POST" class="d-inline">
                            {% if player.carteirinha_forcada %}
                            <span class="badge bg-success me-2">For√ßada Ativa</span>
                            <button type="submit" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times me-1"></i>Desativar Override
                            </button>
                            {% else %}
                            <span class="badge bg-secondary me-2">Normal</span>
                            <button type="submit" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-check me-1"></i>For√ßar Ativa
                            </button>
                            {% endif %}
                        </form>
                    </div>
                    {% endif %}
                    
                    <!-- Bloqueio (apenas jogadores) -->
                    {% if player.tipo_membro != 'vip' %}
                    <div class="mb-3 pb-3 border-bottom">
                        <h6><i class="fas fa-ban me-1"></i> Bloqueio</h6>
                        {% if player.bloqueado == 1 %}
                        <form action="{{ url_for('toggle_bloqueio_jogador', player_id=player.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="fas fa-unlock me-1"></i>Desbloquear
                            </button>
                        </form>
                        {% else %}
                        <form action="{{ url_for('toggle_bloqueio_jogador', player_id=player.id) }}" method="POST" class="d-inline">
                            <select name="motivo" class="form-select form-select-sm d-inline-block me-2" style="width: auto;">
                                <option value="Viagem">üß≥ Viagem</option>
                                <option value="Sa√∫de">üè• Sa√∫de</option>
                                <option value="Outro">üö´ Outro</option>
                            </select>
                            <input type="date" name="bloqueio_ate" class="form-control form-control-sm d-inline-block me-2" style="width: auto;">
                            <button type="submit" class="btn btn-warning btn-sm">
                                <i class="fas fa-lock me-1"></i>Bloquear
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Editar/Excluir -->
                    <div class="d-flex flex-wrap gap-2">
                        {% if player.tipo_membro != 'vip' %}
                        <a href="{{ url_for('adjust_player_position', player_id=player.id) }}" class="btn btn-info btn-sm">
                            <i class="fas fa-arrows-alt-v me-1"></i>Ajustar Posi√ß√£o
                        </a>
                        {% endif %}
                        
                        {% if player.active %}
                        <a href="{{ url_for('deactivate_player', player_id=player.id) }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-user-slash me-1"></i>Desativar
                        </a>
                        {% else %}
                        <a href="{{ url_for('reactivate_player', player_id=player.id) }}" class="btn btn-success btn-sm">
                            <i class="fas fa-user-check me-1"></i>Ativar
                        </a>
                        {% endif %}
                        
                        <form action="{{ url_for('delete_player', player_id=player.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('EXCLUIR permanentemente este jogador? Esta a√ß√£o n√£o pode ser desfeita!')">
                                <i class="fas fa-trash me-1"></i>Excluir
                            </button>
                        </form>
                    </div>
                    
                </div>
            </div>
            {% endif %}
            
            <!-- A√ß√µes do Jogador (criar desafio) -->
            {% if is_own_profile and player.tipo_membro != 'vip' and player.active and not player.bloqueado %}
            <div class="card info-card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-plus me-2"></i>A√ß√µes
                </div>
                <div class="card-body text-center">
                    {% if can_challenge %}
                    <a href="{{ url_for('new_challenge') }}" class="btn btn-success btn-lg">
                        <i class="fas fa-crosshairs me-2"></i>Criar Novo Desafio
                    </a>
                    {% else %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        Voc√™ j√° possui um desafio ativo.
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
        </div>
    </div>
    
</div>
{% endblock %}